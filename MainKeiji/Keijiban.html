<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>掲示板サンプル</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 1em auto; }
  #termsModal, #birthModal, #loginSection, #boardSection { display: none; }
  #termsModal, #birthModal {
    position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); color:#fff; padding: 20px; box-sizing: border-box;
  }
  #termsModal div, #birthModal div { background: #222; padding: 1em; border-radius: 8px; max-width: 400px; margin: 50px auto; }
  button { margin-top: 10px; }
  .post { border-bottom: 1px solid #ddd; padding: 8px 0; }
  .admin-btn { color: red; cursor: pointer; margin-left: 10px; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<!-- 利用規約モーダル -->
<div id="termsModal">
  <div>
    <h2>利用規約</h2>
    <p>掲示板を利用するには利用規約に同意してください。</p>
    <p><iframe src="iframe/Riyou.html" frameborder="0"></iframe></p>
    <label><input type="checkbox" id="agreeCheckbox" /> 同意します</label><br/>
    <button id="agreeBtn" disabled>同意して次へ</button>
  </div>
</div>

<!-- 生年月日モーダル -->
<div id="birthModal">
  <div>
    <h2>生年月日を選択してください</h2>
    <input type="date" id="birthDate" max="" />
    <br/>
    <button id="birthOkBtn">次へ</button>
  </div>
</div>

<!-- ログインセクション -->
<div id="loginSection">
  <h2>ログインしてください</h2>
  <div id="g_id_signin"></div>
  <button id="logoutBtn" style="display:none;">ログアウト</button>
</div>

<!-- 掲示板セクション -->
<div id="boardSection">
  <h2>掲示板</h2>
  <p id="welcome"></p>
  <textarea id="postContent" rows="3" cols="50" placeholder="投稿内容を入力"></textarea><br/>
  <button id="postBtn">投稿する</button>

  <h3>投稿一覧</h3>
  <div id="posts"></div>
</div>

<script>
  // --- 利用規約同意管理 ---
  const termsModal = document.getElementById('termsModal');
  const agreeCheckbox = document.getElementById('agreeCheckbox');
  const agreeBtn = document.getElementById('agreeBtn');

  agreeCheckbox.addEventListener('change', () => {
    agreeBtn.disabled = !agreeCheckbox.checked;
  });
  agreeBtn.addEventListener('click', () => {
    localStorage.setItem('termsAgreed', 'true');
    termsModal.style.display = 'none';
    showBirthModal();
  });

  function checkTerms() {
    if (localStorage.getItem('termsAgreed') !== 'true') {
      termsModal.style.display = 'block';
      return false;
    }
    return true;
  }

  // --- 生年月日チェック ---
  const birthModal = document.getElementById('birthModal');
  const birthDateInput = document.getElementById('birthDate');
  const birthOkBtn = document.getElementById('birthOkBtn');

  // max日付設定 (12歳以上)
  function setMaxBirthDate() {
    const today = new Date();
    const twelveYearsAgo = new Date(today.getFullYear() - 12, today.getMonth(), today.getDate());
    birthDateInput.max = twelveYearsAgo.toISOString().split('T')[0];
  }

  birthOkBtn.addEventListener('click', () => {
    const val = birthDateInput.value;
    if (!val) {
      alert('生年月日を選択してください');
      return;
    }
    const birthDate = new Date(val);
    const today = new Date();
    const twelveYearsAgo = new Date(today.getFullYear() - 12, today.getMonth(), today.getDate());
    if (birthDate > twelveYearsAgo) {
      alert('12歳未満は利用できません');
      return;
    }
    birthModal.style.display = 'none';
    showLoginSection();
  });

  function showBirthModal() {
    setMaxBirthDate();
    birthModal.style.display = 'block';
  }

  // --- Googleログイン ---
  let googleUser = null;
  const loginSection = document.getElementById('loginSection');
  const logoutBtn = document.getElementById('logoutBtn');

  function showLoginSection() {
    loginSection.style.display = 'block';
    renderGoogleButton();
  }

  logoutBtn.onclick = () => {
    googleUser = null;
    localStorage.removeItem('id_token');
    loginSection.style.display = 'block';
    logoutBtn.style.display = 'none';
    boardSection.style.display = 'none';
    welcome.textContent = '';
    renderGoogleButton();
  };

  function handleCredentialResponse(response) {
    // 受け取ったIDトークンをサーバーへ送信し検証
    const idToken = response.credential;
    fetch('/api/login', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({id_token: idToken})
    }).then(res => res.json())
      .then(data => {
        if(data.status === 'ok') {
          googleUser = data;
          localStorage.setItem('id_token', idToken);
          loginSection.style.display = 'none';
          logoutBtn.style.display = 'inline-block';
          showBoardSection(data.email, data.admin);
        } else {
          alert('ログイン失敗:' + data.message);
        }
      });
  }

  function renderGoogleButton() {
    // Google Sign-In button
    google.accounts.id.initialize({
      client_id: 'YOUR_GOOGLE_CLIENT_ID_HERE',
      callback: handleCredentialResponse
    });
    google.accounts.id.renderButton(
      document.getElementById('g_id_signin'),
      { theme: "outline", size: "large", locale: "ja" }
    );
  }

  // --- 掲示板機能 ---
  const boardSection = document.getElementById('boardSection');
  const welcome = document.getElementById('welcome');
  const postContent = document.getElementById('postContent');
  const postBtn = document.getElementById('postBtn');
  const postsDiv = document.getElementById('posts');
  let isAdmin = false;

  function showBoardSection(email, admin) {
    isAdmin = admin;
    welcome.textContent = `${email}さん、ようこそ！`;
    boardSection.style.display = 'block';
    loadPosts();
  }

  function loadPosts() {
    fetch('/api/posts')
      .then(res => res.json())
      .then(data => {
        postsDiv.innerHTML = '';
        data.forEach(post => {
          const div = document.createElement('div');
          div.className = 'post';
          div.textContent = `${post.user_email}: ${post.content}`;
          if (isAdmin) {
            const delBtn = document.createElement('span');
            delBtn.textContent = '[削除]';
            delBtn.className = 'admin-btn';
            delBtn.onclick = () => deletePost(post.id);
            div.appendChild(delBtn);
          }
          postsDiv.appendChild(div);
        });
      });
  }

  function deletePost(id) {
    if(!confirm('この投稿を削除しますか？')) return;
    fetch(`/api/posts?id=${id}`, { method: 'DELETE' })
      .then(res => res.json())
      .then(data => {
        if(data.status === 'ok') loadPosts();
        else alert('削除失敗: ' + data.message);
      });
  }

  postBtn.onclick = () => {
    const content = postContent.value.trim();
    if (!content) {
      alert('投稿内容を入力してください');
      return;
    }
    fetch('/api/posts', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({content})
    }).then(res => res.json())
      .then(data => {
        if (data.status === 'ok') {
          postContent.value = '';
          loadPosts();
        } else {
          alert('投稿失敗: ' + data.message);
        }
      });
  };

  // --- 起動処理 ---
  window.onload = () => {
    if (!checkTerms()) return;
    showBirthModal();
  };
</script>

</body>
</html>
